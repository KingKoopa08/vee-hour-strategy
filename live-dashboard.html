<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Trading Analysis - VEE/HOUR/ISPC Strategy</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0a0a; 
            color: #fff; 
            padding: 10px;
        }
        .container { max-width: 1600px; margin: 0 auto; }
        
        .header { 
            background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%);
            padding: 15px 20px; 
            border-radius: 8px; 
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #333;
        }
        
        .logo { 
            font-size: 24px; 
            font-weight: bold;
            background: linear-gradient(45deg, #00ff88, #00aaff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .status { 
            display: flex; 
            gap: 20px; 
            align-items: center;
            font-size: 14px;
        }
        
        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .online { background: #00ff88; box-shadow: 0 0 10px #00ff88; }
        .offline { background: #ff3366; }
        
        .time-window {
            background: linear-gradient(135deg, #ff3366 0%, #ff6666 100%);
            color: #fff;
            padding: 12px 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: none;
            animation: slideIn 0.3s ease-out;
            font-weight: 500;
        }
        
        @keyframes slideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .time-window.active { display: block; }
        
        .grid { 
            display: grid; 
            grid-template-columns: 300px 1fr; 
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .panel {
            background: #1a1a1a;
            border-radius: 8px;
            padding: 15px;
            border: 1px solid #2a2a2a;
        }
        
        .panel h3 {
            font-size: 16px;
            margin-bottom: 15px;
            color: #00ff88;
        }
        
        .stock-list {
            max-height: 600px;
            overflow-y: auto;
        }
        
        .stock-item {
            padding: 10px;
            margin: 5px 0;
            background: #0a0a0a;
            border: 1px solid #2a2a2a;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .stock-item:hover {
            background: #2a2a2a;
            transform: translateX(5px);
        }
        
        .stock-item.active {
            background: linear-gradient(135deg, #00ff88 0%, #00aa66 100%);
            color: #000;
            border-color: #00ff88;
        }
        
        .stock-symbol {
            font-weight: bold;
            font-size: 14px;
        }
        
        .stock-price {
            font-size: 12px;
            margin-top: 3px;
        }
        
        .stock-change {
            font-size: 11px;
            margin-top: 2px;
        }
        
        .positive { color: #00ff88; }
        .negative { color: #ff3366; }
        
        .main-content {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .price-display {
            background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%);
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #333;
        }
        
        .price-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .current-price {
            font-size: 36px;
            font-weight: bold;
        }
        
        .price-change {
            font-size: 18px;
            margin-top: 5px;
        }
        
        .indicators {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
        }
        
        .indicator {
            background: #0a0a0a;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #2a2a2a;
        }
        
        .indicator-label {
            color: #666;
            font-size: 11px;
            margin-bottom: 5px;
            text-transform: uppercase;
        }
        
        .indicator-value {
            font-size: 18px;
            font-weight: bold;
        }
        
        .signals-panel {
            background: #1a1a1a;
            border-radius: 8px;
            padding: 15px;
            border: 1px solid #2a2a2a;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .signal {
            padding: 12px;
            margin: 8px 0;
            border-radius: 6px;
            border-left: 4px solid;
            background: #0a0a0a;
        }
        
        .signal.buy {
            border-color: #00ff88;
            background: linear-gradient(90deg, rgba(0,255,136,0.1) 0%, transparent 100%);
        }
        
        .signal.sell {
            border-color: #ff3366;
            background: linear-gradient(90deg, rgba(255,51,102,0.1) 0%, transparent 100%);
        }
        
        .signal.warning {
            border-color: #ffaa00;
            background: linear-gradient(90deg, rgba(255,170,0,0.1) 0%, transparent 100%);
        }
        
        .signal-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        
        .signal-type {
            font-weight: bold;
            font-size: 14px;
        }
        
        .signal-confidence {
            font-size: 12px;
            color: #999;
        }
        
        .signal-reason {
            font-size: 12px;
            color: #ccc;
            margin-bottom: 5px;
        }
        
        .signal-details {
            font-size: 11px;
            color: #999;
            display: flex;
            gap: 15px;
        }
        
        #log {
            background: #0a0a0a;
            padding: 10px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid #2a2a2a;
        }
        
        .log-entry {
            padding: 2px 0;
            border-bottom: 1px solid #1a1a1a;
        }
        
        .log-time {
            color: #666;
            margin-right: 10px;
        }
        
        .scanner-stats {
            display: flex;
            gap: 20px;
            padding: 10px;
            background: #0a0a0a;
            border-radius: 6px;
            margin-bottom: 10px;
            font-size: 12px;
        }
        
        .stat-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .stat-label {
            color: #666;
        }
        
        .stat-value {
            color: #00ff88;
            font-weight: bold;
        }
        
        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <div class="logo">Trading Analysis Platform</div>
                <div style="font-size: 12px; color: #666; margin-top: 3px;">
                    VEE/HOUR/ISPC Strategy ‚Ä¢ Live Data from Polygon.io
                </div>
            </div>
            <div class="status">
                <div>
                    <span class="status-indicator offline" id="api-status"></span>
                    <span>API</span>
                </div>
                <div>
                    <span class="status-indicator offline" id="ws-status"></span>
                    <span>Live Feed</span>
                </div>
                <div id="market-status">Market: --</div>
                <div id="time" style="font-weight: bold;">--:--:-- MT</div>
            </div>
        </div>

        <div class="time-window" id="time-window">
            <strong>‚ö†Ô∏è CRITICAL TIME WINDOW</strong>
            <span id="window-message"></span>
        </div>

        <div class="grid">
            <div class="panel">
                <h3>üìà Top Volume Stocks</h3>
                <div class="scanner-stats">
                    <div class="stat-item">
                        <span class="stat-label">Scanned:</span>
                        <span class="stat-value" id="stocks-count">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Active:</span>
                        <span class="stat-value" id="active-count">0</span>
                    </div>
                </div>
                <div class="stock-list" id="stock-list">
                    <div style="text-align: center; color: #666; padding: 20px;">
                        Loading stocks...
                    </div>
                </div>
            </div>

            <div class="main-content">
                <div class="price-display">
                    <div class="price-header">
                        <div>
                            <h2 id="current-symbol">Select a stock</h2>
                            <div class="current-price" id="current-price">--</div>
                            <div class="price-change" id="price-change">--</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 12px; color: #666;">Volume</div>
                            <div style="font-size: 20px; font-weight: bold;" id="volume">--</div>
                            <div style="font-size: 11px; color: #999;" id="volume-ratio">--</div>
                        </div>
                    </div>
                    
                    <div class="indicators">
                        <div class="indicator">
                            <div class="indicator-label">VWAP</div>
                            <div class="indicator-value" id="vwap" style="color: #ff00ff;">--</div>
                        </div>
                        <div class="indicator">
                            <div class="indicator-label">RSI(14)</div>
                            <div class="indicator-value" id="rsi">--</div>
                        </div>
                        <div class="indicator">
                            <div class="indicator-label">vs VWAP</div>
                            <div class="indicator-value" id="vs-vwap">--</div>
                        </div>
                        <div class="indicator">
                            <div class="indicator-label">BB Upper</div>
                            <div class="indicator-value" id="bb-upper">--</div>
                        </div>
                        <div class="indicator">
                            <div class="indicator-label">BB Middle</div>
                            <div class="indicator-value" id="bb-middle">--</div>
                        </div>
                        <div class="indicator">
                            <div class="indicator-label">BB Lower</div>
                            <div class="indicator-value" id="bb-lower">--</div>
                        </div>
                    </div>
                </div>

                <div class="signals-panel">
                    <h3>üéØ Trading Signals</h3>
                    <div id="signals-list">
                        <div style="text-align: center; color: #666; padding: 20px;">
                            No signals yet. Waiting for market conditions...
                        </div>
                    </div>
                </div>

                <div id="log"></div>
            </div>
        </div>
    </div>

    <script>
        let currentSymbol = null;
        let ws = null;
        let stocksData = {};
        const API_URL = window.location.hostname === 'localhost' ? 'http://localhost:3018' : `http://${window.location.hostname}:3018`;
        const WS_URL = 'ws://localhost:3006';

        // Format numbers
        function formatNumber(num) {
            if (num >= 1000000000) return (num / 1000000000).toFixed(2) + 'B';
            if (num >= 1000000) return (num / 1000000).toFixed(2) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(2) + 'K';
            return num.toFixed(2);
        }

        // Update time
        function updateTime() {
            const now = new Date();
            const mtTime = new Date(now.toLocaleString("en-US", {timeZone: "America/Denver"}));
            document.getElementById('time').textContent = 
                mtTime.toLocaleTimeString('en-US', { hour12: false }) + ' MT';
            
            // Check time windows
            const hours = mtTime.getHours();
            const minutes = mtTime.getMinutes();
            const currentTime = hours * 60 + minutes;
            
            const windows = [
                { start: 6 * 60 + 3, end: 6 * 60 + 7, message: "PRIMARY ENTRY WINDOW (6:05 AM) - Check for stocks trending down with volume" },
                { start: 6 * 60 + 10, end: 6 * 60 + 35, message: "TARGET SELL WINDOW (6:10-6:35 AM) - Take profits at 3% or VWAP cross" },
                { start: 6 * 60 + 33, end: 6 * 60 + 37, message: "DIRECTIONAL BIAS (6:35 AM) - Confirm market direction" },
                { start: 7 * 60 + 53, end: 7 * 60 + 57, message: "BREAKOUT WINDOW (7:55 AM) - Watch for volume breakouts" }
            ];
            
            const activeWindow = windows.find(w => currentTime >= w.start && currentTime <= w.end);
            const windowEl = document.getElementById('time-window');
            
            if (activeWindow) {
                windowEl.classList.add('active');
                document.getElementById('window-message').textContent = activeWindow.message;
            } else {
                windowEl.classList.remove('active');
            }
        }
        setInterval(updateTime, 1000);
        updateTime();

        // Log function
        function log(message, type = 'info') {
            const logEl = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#ff3366' : type === 'success' ? '#00ff88' : '#fff';
            const entry = `<div class="log-entry"><span class="log-time">${time}</span><span style="color: ${color}">${message}</span></div>`;
            logEl.innerHTML = entry + logEl.innerHTML;
            if (logEl.children.length > 50) {
                logEl.removeChild(logEl.lastChild);
            }
        }

        // Load top volume stocks
        async function loadTopStocks() {
            try {
                const response = await fetch(`${API_URL}/api/stocks/top-volume`);
                const data = await response.json();
                
                if (data.success && data.data) {
                    const stockList = document.getElementById('stock-list');
                    stockList.innerHTML = '';
                    
                    document.getElementById('stocks-count').textContent = data.data.length;
                    
                    for (const symbol of data.data) {
                        // Fetch snapshot for each stock
                        try {
                            const snapResponse = await fetch(`${API_URL}/api/stocks/${symbol}/snapshot`);
                            const snapData = await snapResponse.json();
                            
                            if (snapData.success) {
                                stocksData[symbol] = snapData.data;
                                
                                const item = document.createElement('div');
                                item.className = 'stock-item';
                                item.dataset.symbol = symbol;
                                
                                const changeClass = snapData.data.changePercent >= 0 ? 'positive' : 'negative';
                                const changeSymbol = snapData.data.changePercent >= 0 ? '+' : '';
                                
                                item.innerHTML = `
                                    <div class="stock-symbol">${symbol}</div>
                                    <div class="stock-price">$${snapData.data.price.toFixed(2)}</div>
                                    <div class="stock-change ${changeClass}">
                                        ${changeSymbol}${snapData.data.changePercent.toFixed(2)}% | Vol: ${formatNumber(snapData.data.volume)}
                                    </div>
                                `;
                                
                                item.onclick = () => selectStock(symbol);
                                stockList.appendChild(item);
                            }
                        } catch (error) {
                            console.error(`Error loading ${symbol}:`, error);
                        }
                    }
                    
                    // Auto-select first stock if none selected
                    if (!currentSymbol && data.data.length > 0) {
                        selectStock(data.data[0]);
                    }
                }
            } catch (error) {
                log('Error loading stocks: ' + error.message, 'error');
            }
        }

        // Select stock
        async function selectStock(symbol) {
            currentSymbol = symbol;
            
            // Update UI
            document.querySelectorAll('.stock-item').forEach(item => {
                item.classList.toggle('active', item.dataset.symbol === symbol);
            });
            
            document.getElementById('current-symbol').textContent = symbol;
            
            // Update price display
            if (stocksData[symbol]) {
                updatePriceDisplay(stocksData[symbol]);
            }
            
            // Load indicators
            loadIndicators(symbol);
            
            // Load signals
            loadSignals(symbol);
            
            // Subscribe to WebSocket updates
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'subscribe',
                    payload: { symbols: [symbol] }
                }));
            }
            
            log(`Selected ${symbol}`);
        }

        // Update price display
        function updatePriceDisplay(data) {
            document.getElementById('current-price').textContent = '$' + data.price.toFixed(2);
            
            const changeEl = document.getElementById('price-change');
            const changeClass = data.changePercent >= 0 ? 'positive' : 'negative';
            const changeSymbol = data.changePercent >= 0 ? '+' : '';
            changeEl.innerHTML = `<span class="${changeClass}">${changeSymbol}$${data.change.toFixed(2)} (${changeSymbol}${data.changePercent.toFixed(2)}%)</span>`;
            
            document.getElementById('volume').textContent = formatNumber(data.volume);
        }

        // Load indicators
        async function loadIndicators(symbol) {
            try {
                const response = await fetch(`${API_URL}/api/stocks/${symbol}/indicators`);
                const data = await response.json();
                
                if (data.success && data.data) {
                    const ind = data.data;
                    
                    document.getElementById('vwap').textContent = '$' + ind.vwap.toFixed(2);
                    
                    // RSI coloring
                    const rsiEl = document.getElementById('rsi');
                    rsiEl.textContent = ind.rsi.toFixed(1);
                    rsiEl.style.color = ind.rsi > 70 ? '#ff3366' : ind.rsi < 30 ? '#00ff88' : '#fff';
                    
                    // Price vs VWAP
                    const vsVwap = ((ind.currentPrice - ind.vwap) / ind.vwap * 100);
                    const vsVwapEl = document.getElementById('vs-vwap');
                    vsVwapEl.textContent = (vsVwap >= 0 ? '+' : '') + vsVwap.toFixed(2) + '%';
                    vsVwapEl.style.color = vsVwap >= 0 ? '#00ff88' : '#ff3366';
                    
                    // Bollinger Bands
                    document.getElementById('bb-upper').textContent = '$' + ind.bollingerBands.upper.toFixed(2);
                    document.getElementById('bb-middle').textContent = '$' + ind.bollingerBands.middle.toFixed(2);
                    document.getElementById('bb-lower').textContent = '$' + ind.bollingerBands.lower.toFixed(2);
                    
                    // Volume ratio
                    document.getElementById('volume-ratio').textContent = 'Ratio: ' + ind.volumeRatio.toFixed(2) + 'x avg';
                }
            } catch (error) {
                log('Error loading indicators: ' + error.message, 'error');
            }
        }

        // Load signals
        async function loadSignals(symbol) {
            try {
                const response = await fetch(`${API_URL}/api/stocks/${symbol}/signals`);
                const data = await response.json();
                
                if (data.success && data.data) {
                    const signalsList = document.getElementById('signals-list');
                    
                    if (data.data.length === 0) {
                        signalsList.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">No signals for ' + symbol + '</div>';
                    } else {
                        signalsList.innerHTML = '';
                        
                        data.data.forEach(signal => {
                            const signalEl = document.createElement('div');
                            signalEl.className = `signal ${signal.type.toLowerCase()}`;
                            
                            signalEl.innerHTML = `
                                <div class="signal-header">
                                    <span class="signal-type">${signal.type} - ${signal.strength}</span>
                                    <span class="signal-confidence">Confidence: ${signal.confidence}%</span>
                                </div>
                                <div class="signal-reason">${signal.reason}</div>
                                <div class="signal-details">
                                    <span>Price: $${signal.price.toFixed(2)}</span>
                                    ${signal.targetPrice ? `<span>Target: $${signal.targetPrice.toFixed(2)}</span>` : ''}
                                    ${signal.stopLoss ? `<span>Stop: $${signal.stopLoss.toFixed(2)}</span>` : ''}
                                    ${signal.timeWindow ? `<span>${signal.timeWindow}</span>` : ''}
                                </div>
                            `;
                            
                            signalsList.appendChild(signalEl);
                        });
                    }
                }
            } catch (error) {
                log('Error loading signals: ' + error.message, 'error');
            }
        }

        // Test API connection
        async function testAPI() {
            try {
                const response = await fetch(`${API_URL}/health`);
                if (response.ok) {
                    document.getElementById('api-status').classList.remove('offline');
                    document.getElementById('api-status').classList.add('online');
                    log('API connected - Live Polygon.io data', 'success');
                    
                    // Check market status
                    const marketResponse = await fetch(`${API_URL}/api/market/status`);
                    const marketData = await marketResponse.json();
                    document.getElementById('market-status').textContent = 
                        'Market: ' + (marketData.data?.status || 'Unknown').toUpperCase();
                    
                    return true;
                }
            } catch (error) {
                document.getElementById('api-status').classList.remove('online');
                document.getElementById('api-status').classList.add('offline');
                log('API connection failed', 'error');
                return false;
            }
        }

        // Connect WebSocket
        function connectWebSocket() {
            try {
                ws = new WebSocket(WS_URL);
                
                ws.onopen = () => {
                    document.getElementById('ws-status').classList.remove('offline');
                    document.getElementById('ws-status').classList.add('online');
                    log('Live feed connected', 'success');
                    
                    // Subscribe to current symbol if selected
                    if (currentSymbol) {
                        ws.send(JSON.stringify({
                            type: 'subscribe',
                            payload: { symbols: [currentSymbol] }
                        }));
                    }
                };
                
                ws.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    if (data.type === 'priceUpdate' && data.data.symbol === currentSymbol) {
                        // Update live data
                        if (data.data.indicators) {
                            updatePriceDisplay({
                                price: data.data.price,
                                change: data.data.price - (stocksData[currentSymbol]?.prevClose || data.data.price),
                                changePercent: data.data.change,
                                volume: data.data.volume
                            });
                            
                            // Update indicators
                            const ind = data.data.indicators;
                            document.getElementById('vwap').textContent = '$' + ind.vwap.toFixed(2);
                            document.getElementById('rsi').textContent = ind.rsi.toFixed(1);
                            
                            // Add new signals if any
                            if (data.data.signals && data.data.signals.length > 0) {
                                data.data.signals.forEach(signal => {
                                    log(`New ${signal.type} signal for ${currentSymbol}: ${signal.reason}`, 
                                        signal.type === 'BUY' ? 'success' : 'error');
                                });
                                loadSignals(currentSymbol);
                            }
                        }
                    }
                };
                
                ws.onerror = () => {
                    document.getElementById('ws-status').classList.remove('online');
                    document.getElementById('ws-status').classList.add('offline');
                    log('Live feed error', 'error');
                };
                
                ws.onclose = () => {
                    document.getElementById('ws-status').classList.remove('online');
                    document.getElementById('ws-status').classList.add('offline');
                    log('Live feed disconnected', 'error');
                    setTimeout(connectWebSocket, 5000);
                };
            } catch (error) {
                log('WebSocket connection failed', 'error');
            }
        }

        // Initialize
        async function init() {
            log('Initializing Live Trading Platform...');
            const apiConnected = await testAPI();
            if (apiConnected) {
                await loadTopStocks();
                connectWebSocket();
                
                // Refresh stocks every minute
                setInterval(loadTopStocks, 60000);
                
                // Refresh current stock data every 10 seconds
                setInterval(() => {
                    if (currentSymbol) {
                        loadIndicators(currentSymbol);
                        loadSignals(currentSymbol);
                    }
                }, 10000);
            } else {
                log('Waiting for backend...', 'error');
                setTimeout(init, 5000);
            }
        }

        init();
    </script>
</body>
</html>