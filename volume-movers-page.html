<!DOCTYPE html>
<html>
<head>
    <title>Volume Movers - Multi-Timeframe Scanner</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 100%);
            color: #e0e0e0;
            padding: 20px;
            min-height: 100vh;
        }

        .nav-bar {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(0, 255, 65, 0.3);
            border-radius: 10px;
            padding: 15px 20px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nav-links {
            display: flex;
            gap: 20px;
        }

        .nav-links a {
            color: #00ff41;
            text-decoration: none;
            padding: 8px 15px;
            border-radius: 5px;
            transition: all 0.3s ease;
        }

        .nav-links a:hover {
            background: rgba(0, 255, 65, 0.1);
        }

        .nav-links a.active {
            background: rgba(0, 255, 65, 0.2);
            border: 1px solid rgba(0, 255, 65, 0.5);
        }

        h1 {
            font-size: 2.5em;
            background: linear-gradient(135deg, #00ff41, #00ffff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-align: center;
            margin-bottom: 20px;
        }

        .filters {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(0, 255, 65, 0.3);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .filter-group label {
            color: #00ffff;
            font-weight: 500;
        }

        .filter-group select,
        .filter-group input {
            background: rgba(0, 0, 0, 0.5);
            color: #e0e0e0;
            border: 1px solid rgba(0, 255, 65, 0.3);
            border-radius: 5px;
            padding: 8px 12px;
            font-size: 14px;
        }

        .status {
            text-align: center;
            padding: 15px;
            background: rgba(0, 255, 65, 0.1);
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid rgba(0, 255, 65, 0.3);
        }

        .status.connected {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% {
                border-color: rgba(0, 255, 65, 0.3);
            }
            50% {
                border-color: rgba(0, 255, 65, 0.8);
            }
        }

        .stats-container {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .stat-item {
            color: #00ffff;
            font-weight: 500;
        }

        .stat-value {
            color: #00ff41;
            font-weight: bold;
            margin-left: 5px;
        }

        table {
            width: 100%;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid rgba(0, 255, 65, 0.2);
        }

        th {
            background: rgba(0, 255, 65, 0.1);
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #00ff41;
            border-bottom: 2px solid rgba(0, 255, 65, 0.3);
        }

        th.sortable {
            cursor: pointer;
            user-select: none;
            position: relative;
        }

        th.sortable:hover {
            background: rgba(0, 255, 65, 0.15);
        }

        th.sortable::after {
            content: ' ‚áÖ';
            opacity: 0.3;
            font-size: 0.8em;
        }

        th.sortable.sorted-asc::after {
            content: ' ‚Üë';
            opacity: 1;
        }

        th.sortable.sorted-desc::after {
            content: ' ‚Üì';
            opacity: 1;
        }

        td {
            padding: 12px 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        tr:hover {
            background: rgba(0, 255, 65, 0.05);
        }

        .symbol {
            font-weight: bold;
            color: #00ffff;
            font-size: 1.1em;
        }

        .positive {
            color: #00ff41;
            font-weight: 500;
        }

        .negative {
            color: #ff4444;
        }

        .high-volume {
            color: #ffd700;
            font-weight: bold;
        }

        .volume-change {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: bold;
            min-width: 60px;
            text-align: center;
            font-size: 0.9em;
        }

        .volume-spike {
            background: rgba(255, 65, 0, 0.3);
            color: #ff8c00;
            border: 1px solid rgba(255, 65, 0, 0.5);
        }

        .volume-surge {
            background: rgba(0, 255, 65, 0.2);
            color: #00ff41;
            border: 1px solid rgba(0, 255, 65, 0.4);
        }

        .volume-normal {
            background: rgba(255, 255, 255, 0.05);
            color: #888;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Price change styles - direction based coloring */
        .price-positive {
            color: #00ff41;
        }

        .price-negative {
            color: #ff4444;
        }

        .price-neutral {
            color: #888;
        }

        /* Price change intensity modifiers */
        .price-positive.price-spike {
            background: rgba(0, 255, 65, 0.3);
            font-weight: bold;
            border: 1px solid rgba(0, 255, 65, 0.5);
            padding: 2px 6px;
            border-radius: 3px;
        }

        .price-positive.price-surge {
            background: rgba(0, 255, 65, 0.2);
            font-weight: 600;
            border: 1px solid rgba(0, 255, 65, 0.4);
            padding: 2px 6px;
            border-radius: 3px;
        }

        .price-positive.price-normal {
            background: rgba(0, 255, 65, 0.1);
            padding: 2px 6px;
            border-radius: 3px;
        }

        .price-negative.price-spike {
            background: rgba(255, 68, 68, 0.3);
            font-weight: bold;
            border: 1px solid rgba(255, 68, 68, 0.5);
            padding: 2px 6px;
            border-radius: 3px;
        }

        .price-negative.price-surge {
            background: rgba(255, 68, 68, 0.2);
            font-weight: 600;
            border: 1px solid rgba(255, 68, 68, 0.4);
            padding: 2px 6px;
            border-radius: 3px;
        }

        .price-negative.price-normal {
            background: rgba(255, 68, 68, 0.1);
            padding: 2px 6px;
            border-radius: 3px;
        }

        .loading {
            text-align: center;
            padding: 50px;
            font-size: 1.2em;
            color: #00ff41;
        }

        #connection-status {
            padding: 5px 10px;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.1);
            font-weight: 500;
        }

        #connection-status.connected {
            color: #00ff41;
        }

        #connection-status.disconnected {
            color: #ff4444;
        }

        #connection-status.connecting {
            color: #ffd700;
        }
    </style>
</head>
<body>
    <div class="nav-bar">
        <div class="nav-links">
            <a href="/">üè† Home</a>
            <a href="/gainers">üî• Top Gainers</a>
            <a href="/volume" class="active">üìä Volume Movers</a>
        </div>
        <div id="connection-status" class="disconnected">üî¥ Connecting...</div>
    </div>

    <h1>üìà Real-Time Volume Movers</h1>

    <div id="marketSession" style="text-align: center; margin-bottom: 20px; padding: 10px; background: rgba(0, 255, 65, 0.1); border: 1px solid rgba(0, 255, 65, 0.3); border-radius: 10px;">
        <span style="color: #00ffff; font-weight: 600;">Market Session: </span>
        <span id="sessionName" style="color: #00ff41; font-weight: bold;">Loading...</span>
    </div>

    <!-- Buy Pressure Indicator Explanation -->
    <div style="
        background: linear-gradient(135deg, rgba(0, 100, 200, 0.1) 0%, rgba(0, 50, 150, 0.05) 100%);
        border: 1px solid rgba(0, 150, 255, 0.3);
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
    ">
        <h3 style="color: #00aaff; margin-top: 0; margin-bottom: 10px; font-size: 1.1em;">üìä Buy Pressure Indicator</h3>
        <div style="color: #ccc; font-size: 0.9em; line-height: 1.6;">
            <p style="margin: 0 0 10px 0;">
                The <strong style="color: #00ff41;">Buy Pressure Indicator</strong> estimates buying strength on a 0-100 scale by analyzing:
            </p>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin: 15px 0;">
                <div style="background: rgba(0, 0, 0, 0.3); padding: 10px; border-radius: 5px;">
                    <strong style="color: #00aaff;">üìà Price Movement (40%)</strong><br>
                    <span style="font-size: 0.85em;">Recent price changes indicate direction</span>
                </div>
                <div style="background: rgba(0, 0, 0, 0.3); padding: 10px; border-radius: 5px;">
                    <strong style="color: #00aaff;">üìä Volume Surge (30%)</strong><br>
                    <span style="font-size: 0.85em;">High volume with price rise suggests buying</span>
                </div>
                <div style="background: rgba(0, 0, 0, 0.3); padding: 10px; border-radius: 5px;">
                    <strong style="color: #00aaff;">üìâ Trend Analysis (30%)</strong><br>
                    <span style="font-size: 0.85em;">Sustained movements across timeframes</span>
                </div>
            </div>
            <div style="display: flex; gap: 20px; align-items: center; justify-content: center; margin-top: 10px;">
                <span>üî¥ <strong>&lt;30</strong> = Selling Pressure</span>
                <span>‚ûñ <strong>40-60</strong> = Neutral</span>
                <span>üü¢ <strong>&gt;70</strong> = Buying Pressure</span>
            </div>
            <p style="margin: 10px 0 0 0; color: #999; font-size: 0.85em; font-style: italic;">
                Note: This is an approximation based on price/volume patterns. Actual buy/sell volume requires Level 2 data.
            </p>
        </div>
    </div>

    <!-- Change Indicators Legend -->
    <div style="background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(0, 255, 65, 0.3); border-radius: 10px; padding: 15px; margin-bottom: 20px;">
        <h3 style="color: #00ffff; margin-bottom: 15px; font-size: 1.1em; text-align: center;">Change Indicators</h3>

        <!-- Price Changes Row -->
        <div style="margin-bottom: 12px;">
            <div style="color: #fff; font-weight: 600; margin-bottom: 8px; font-size: 0.95em;">Price Changes:</div>
            <div style="display: flex; justify-content: center; gap: 20px; flex-wrap: wrap;">
                <div style="display: flex; align-items: center; gap: 8px;">
                    <span class="price-change price-positive price-spike" style="display: inline-block; min-width: 50px; text-align: center;">+2.0%</span>
                    <span style="color: #888; font-size: 0.85em;">Strong Move (‚â•2%)</span>
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <span class="price-change price-positive price-surge" style="display: inline-block; min-width: 50px; text-align: center;">+1.0%</span>
                    <span style="color: #888; font-size: 0.85em;">Notable Move (0.5-2%)</span>
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <span class="price-change price-positive price-normal" style="display: inline-block; min-width: 50px; text-align: center;">+0.2%</span>
                    <span style="color: #888; font-size: 0.85em;">Small Move (&lt;0.5%)</span>
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <span class="price-change price-negative price-spike" style="display: inline-block; min-width: 50px; text-align: center;">-2.0%</span>
                    <span style="color: #888; font-size: 0.85em;">Strong Drop</span>
                </div>
            </div>
        </div>

        <!-- Volume Changes Row -->
        <div>
            <div style="color: #fff; font-weight: 600; margin-bottom: 8px; font-size: 0.95em;">Volume Changes:</div>
            <div style="display: flex; justify-content: center; gap: 20px; flex-wrap: wrap;">
                <div style="display: flex; align-items: center; gap: 8px;">
                    <span class="volume-change volume-spike" style="display: inline-block; min-width: 50px; text-align: center;">+50%</span>
                    <span style="color: #888; font-size: 0.85em;">Volume Spike (‚â•50%)</span>
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <span class="volume-change volume-surge" style="display: inline-block; min-width: 50px; text-align: center;">+25%</span>
                    <span style="color: #888; font-size: 0.85em;">Volume Surge (20-49%)</span>
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <span class="volume-change volume-normal" style="display: inline-block; min-width: 50px; text-align: center;">+5%</span>
                    <span style="color: #888; font-size: 0.85em;">Normal (&lt;20%)</span>
                </div>
            </div>
        </div>

        <p style="color: #666; margin-top: 12px; font-size: 0.8em; text-align: center; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 10px;">
            Real-time tracking over 30s, 1m, 2m, 3m, and 5m timeframes ‚Ä¢ Updates every second
        </p>
    </div>

    <div class="filters">
        <div class="filter-group" style="flex: 0 0 auto; min-width: 200px;">
            <label for="tickerSearch">üîç Find Ticker:</label>
            <input type="text" id="tickerSearch" placeholder="Enter symbol..."
                   style="width: 120px; text-transform: uppercase; background: rgba(0, 0, 0, 0.5); color: #00ff41; border: 1px solid rgba(0, 255, 65, 0.3); border-radius: 5px; padding: 8px 12px;">
            <button id="clearSearch" style="background: rgba(255, 0, 0, 0.2); color: #ff4444; border: 1px solid rgba(255, 68, 68, 0.3); border-radius: 5px; padding: 8px 12px; margin-left: 5px; cursor: pointer; display: none;">Clear</button>
        </div>
        <div class="filter-group">
            <label for="stockLimit">Show Top:</label>
            <select id="stockLimit">
                <option value="10">10 Stocks</option>
                <option value="20">20 Stocks</option>
                <option value="30">30 Stocks</option>
                <option value="50" selected>50 Stocks</option>
                <option value="100">100 Stocks</option>
            </select>
        </div>
        <div class="filter-group">
            <label for="minGain">Min Gain:</label>
            <input type="number" id="minGain" value="0" step="0.5" style="width: 80px">
            <span>%</span>
        </div>
        <div class="filter-group">
            <label for="minVolume" title="Filters by total daily volume">Min Total Vol:</label>
            <select id="minVolume">
                <option value="0">Any</option>
                <option value="500000" selected>500K+</option>
                <option value="1000000">1M+</option>
                <option value="5000000">5M+</option>
                <option value="10000000">10M+</option>
            </select>
        </div>
        <div class="filter-group">
            <label for="priceSortBy">Sort Price Œî:</label>
            <select id="priceSortBy">
                <option value="none">None</option>
                <option value="priceChange30s">30s</option>
                <option value="priceChange1m">1m</option>
                <option value="priceChange2m">2m</option>
                <option value="priceChange3m">3m</option>
                <option value="priceChange5m">5m</option>
            </select>
        </div>
        <div class="filter-group">
            <label for="volumeSortBy">Sort Vol Œî:</label>
            <select id="volumeSortBy">
                <option value="none">None</option>
                <option value="volumeChange30s">30s</option>
                <option value="volumeChange1m">1m</option>
                <option value="volumeChange2m">2m</option>
                <option value="volumeChange3m">3m</option>
                <option value="volumeChange5m">5m</option>
            </select>
        </div>
        <div class="filter-group">
            <label for="priceFilter">Price Range:</label>
            <select id="priceFilter">
                <option value="all" selected>All Prices</option>
                <option value="penny">Under $5</option>
                <option value="low">$5 - $20</option>
                <option value="mid">$20 - $100</option>
                <option value="high">Over $100</option>
            </select>
        </div>
        <div class="filter-group">
            <label for="primarySort">Primary Sort:</label>
            <select id="primarySort">
                <option value="dayChange" selected>Day %</option>
                <option value="price">Price</option>
                <option value="volume">Volume</option>
            </select>
        </div>
    </div>

    <div class="status connected">
        <div class="stats-container">
            <div class="stat-item">Stocks Tracked:<span class="stat-value" id="stockCount">0</span></div>
            <div class="stat-item">Volume Surges:<span class="stat-value" id="surgeCount">0</span></div>
            <div class="stat-item">Last Update:<span class="stat-value" id="lastUpdate">--:--:--</span></div>
        </div>
    </div>

    <table id="volumeTable">
        <thead>
            <tr>
                <th rowspan="2">Rank</th>
                <th rowspan="2">Symbol</th>
                <th rowspan="2" class="sortable" data-sort="price">Price</th>
                <th rowspan="2" class="sortable sorted-desc" data-sort="dayChange">Day %</th>
                <th rowspan="2" class="sortable" data-sort="buyPressure">
                    Buy Pressure
                    <span style="
                        display: inline-block;
                        width: 16px;
                        height: 16px;
                        border-radius: 50%;
                        background: #0088ff;
                        color: white;
                        font-size: 11px;
                        line-height: 16px;
                        text-align: center;
                        cursor: help;
                        margin-left: 4px;
                        font-weight: bold;
                    " title="Buy Pressure Calculation:

Base: 50 (neutral)

1. Price Movement (¬±20 points max):
   ‚Ä¢ If price ‚Üë in 30s: +min(20, price% √ó 4)
   ‚Ä¢ If price ‚Üì in 30s: -min(20, price% √ó 4)

2. Volume Surge (¬±15 points max):
   ‚Ä¢ Volume ‚Üë + Price ‚Üë: +min(15, vol%/10)
   ‚Ä¢ Volume ‚Üë + Price ‚Üì: -min(15, vol%/10)

3. Sustained Trend (¬±15 points):
   ‚Ä¢ 1m + 30s both ‚Üë: +15 (buying trend)
   ‚Ä¢ 1m + 30s both ‚Üì: -15 (selling trend)

Final: Clamped to 0-100 range
‚Ä¢ >70 = Strong Buy Pressure üü¢
‚Ä¢ 40-60 = Neutral ‚ûñ
‚Ä¢ <30 = Strong Sell Pressure üî¥

Note: Resets to 50 when no trades occur">?</span>
                </th>
                <th colspan="5" style="text-align: center; border-bottom: 1px solid rgba(0, 255, 65, 0.2);">Price Œî%</th>
                <th colspan="5" style="text-align: center; border-bottom: 1px solid rgba(0, 255, 65, 0.2);">Volume Œî%</th>
                <th rowspan="2" class="sortable" data-sort="volume" id="volumeHeader">Total Volume</th>
            </tr>
            <tr>
                <th style="font-size: 0.9em;">30s</th>
                <th style="font-size: 0.9em;">1m</th>
                <th style="font-size: 0.9em;">2m</th>
                <th style="font-size: 0.9em;">3m</th>
                <th style="font-size: 0.9em;">5m</th>
                <th style="font-size: 0.9em;" title="Volume Rate or Activity">Rate</th>
                <th style="font-size: 0.9em;">1m</th>
                <th style="font-size: 0.9em;">2m</th>
                <th style="font-size: 0.9em;">3m</th>
                <th style="font-size: 0.9em;">5m</th>
            </tr>
        </thead>
        <tbody id="tableBody">
            <tr class="loading">
                <td colspan="15">Loading volume data...</td>
            </tr>
        </tbody>
    </table>

    <script>
        // Version timestamp to verify page refresh
        const PAGE_VERSION = '2025-09-24-v3';

        // Immediate debug output - runs as soon as script loads
        console.log('=====================================');
        console.log('üöÄ Volume Movers Page - Debug Mode ON');
        console.log(`üìÖ Page loaded at: ${new Date().toLocaleTimeString()}`);
        console.log(`üì¶ Version: ${PAGE_VERSION}`);
        console.log('üëÄ Monitoring :40 to :05 seconds');
        console.log('=====================================');

        let ws;
        let allStocks = [];
        let filters = {
            minVolume: 500000,
            minGain: 0,
            primarySort: 'dayChange',
            primarySortDirection: 'desc', // 'asc' or 'desc'
            priceSortBy: 'none',
            volumeSortBy: 'none',
            stockLimit: 50
        };

        // Initialize sorting functionality
        function initializeSorting() {
            // Add click handlers for sortable headers
            const sortableHeaders = document.querySelectorAll('th.sortable');

            sortableHeaders.forEach(th => {
                th.addEventListener('click', function() {
                    const sortField = this.dataset.sort;

                    // If clicking the same field, toggle direction
                    if (filters.primarySort === sortField) {
                        filters.primarySortDirection = filters.primarySortDirection === 'desc' ? 'asc' : 'desc';
                    } else {
                        // New field, default to descending
                        filters.primarySort = sortField;
                        filters.primarySortDirection = 'desc';
                    }

                    // Update UI to show sort direction
                    document.querySelectorAll('th.sortable').forEach(header => {
                        header.classList.remove('sorted-asc', 'sorted-desc');
                    });
                    this.classList.add('sorted-' + filters.primarySortDirection);

                    // Update dropdown to match
                    document.getElementById('primarySort').value = sortField;

                    updateTable(allStocks);
                });
            });
        }

        // Initialize filter event listeners
        function initializeFilters() {
            // Ticker search functionality
            const tickerSearch = document.getElementById('tickerSearch');
            const clearSearch = document.getElementById('clearSearch');

            tickerSearch.addEventListener('input', (e) => {
                const searchValue = e.target.value.toUpperCase().trim();
                filters.tickerSearch = searchValue;
                clearSearch.style.display = searchValue ? 'inline-block' : 'none';
                updateTable(allStocks);
            });

            clearSearch.addEventListener('click', () => {
                tickerSearch.value = '';
                filters.tickerSearch = '';
                clearSearch.style.display = 'none';
                updateTable(allStocks);
            });

            document.getElementById('stockLimit').addEventListener('change', (e) => {
                filters.stockLimit = parseInt(e.target.value);
                updateTable(allStocks);
            });

            document.getElementById('minGain').addEventListener('input', (e) => {
                filters.minGain = parseFloat(e.target.value) || 0;
                updateTable(allStocks);
            });

            document.getElementById('minVolume').addEventListener('change', (e) => {
                filters.minVolume = parseInt(e.target.value);
                updateTable(allStocks);
            });

            document.getElementById('primarySort').addEventListener('change', (e) => {
                filters.primarySort = e.target.value;
                // Reset sort direction when changing via dropdown
                filters.primarySortDirection = 'desc';

                // Update header classes
                document.querySelectorAll('th.sortable').forEach(header => {
                    header.classList.remove('sorted-asc', 'sorted-desc');
                    if (header.dataset.sort === e.target.value) {
                        header.classList.add('sorted-desc');
                    }
                });

                updateTable(allStocks);
            });

            document.getElementById('priceSortBy').addEventListener('change', (e) => {
                filters.priceSortBy = e.target.value;
                updateTable(allStocks);
            });

            document.getElementById('volumeSortBy').addEventListener('change', (e) => {
                filters.volumeSortBy = e.target.value;
                updateTable(allStocks);
            });

            document.getElementById('priceFilter').addEventListener('change', (e) => {
                updateTable(allStocks);
            });
        }

        // Wait for DOM to be ready
        document.addEventListener('DOMContentLoaded', function() {
            initializeSorting();
            initializeFilters();
            connect();
            fetchInitialData();
        });

        // Connect to WebSocket
        function connect() {
            const wsHost = window.location.hostname || 'localhost';
            const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';

            // Handle different environments
            let wsUrl;
            if (wsHost === 'localhost' || wsHost === '127.0.0.1') {
                // Local development
                wsUrl = `ws://${wsHost}:3051`;
            } else if (wsProtocol === 'wss:') {
                // HTTPS connection - use WSS through nginx proxy
                wsUrl = `${wsProtocol}//${wsHost}/ws`;
            } else {
                // Direct HTTP/IP access - connect directly to WebSocket port
                wsUrl = `ws://${wsHost}:3051`;
            }
            ws = new WebSocket(wsUrl);

            ws.onopen = () => {
                console.log('Connected to WebSocket');
                const statusEl = document.getElementById('connection-status');
                statusEl.innerHTML = 'üü¢ Connected';
                statusEl.className = 'connected';

                // Request initial data only when fully connected
                if (ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({ type: 'subscribe', channel: 'volumeMovers' }));
                }
            };

            // Track last message time for gap detection
            let lastMessageTime = Date.now();

            // Monitor for gaps in messages every second
            setInterval(() => {
                const now = Date.now();
                const seconds = new Date().getSeconds();
                const timeSinceLastMessage = now - lastMessageTime;

                // Alert if no message for more than 2 seconds during critical window
                if (timeSinceLastMessage > 2000 && (seconds >= 40 || seconds <= 5)) {
                    console.warn(`‚ö†Ô∏è [${new Date().toLocaleTimeString()}] No WebSocket messages for ${(timeSinceLastMessage/1000).toFixed(1)}s at :${seconds}s`);
                }
            }, 1000);

            ws.onmessage = (event) => {
                const now = new Date();
                const seconds = now.getSeconds();
                const timeString = now.toLocaleTimeString() + '.' + now.getMilliseconds().toString().padStart(3, '0');

                // Update last message time
                lastMessageTime = Date.now();

                // Enhanced debug logging around :42 to :01 window
                if (seconds >= 40 || seconds <= 5) {
                    console.log(`üì® [${timeString}] WebSocket message received at :${seconds}s`);
                    console.log(`   Message size: ${event.data.length} bytes`);
                }

                const data = JSON.parse(event.data);

                if (data.type === 'volumeMovers') {
                    // Log data details during critical window
                    if (seconds >= 40 || seconds <= 5) {
                        console.log(`   Data type: volumeMovers`);
                        console.log(`   Stocks count: ${data.data ? data.data.length : 0}`);
                        if (data.data && data.data.length > 0) {
                            const sample = data.data[0];
                            console.log(`   Sample stock: ${sample.symbol} - Buy Pressure: ${sample.buyPressure}`);
                        }
                    }

                    // Store the raw data
                    allStocks = data.data;

                    // Apply current filters and sorting
                    updateTable(allStocks);

                    // Update last update time with milliseconds to show real-time updates
                    document.getElementById('lastUpdate').innerHTML = `${timeString} <span style="color: #00ff41;">‚óè</span>`;

                    // Log update completion
                    if (seconds >= 40 || seconds <= 5) {
                        console.log(`‚úÖ Table updated at :${seconds}s`);
                    }

                    // Flash indicator to show update received
                    const indicator = document.getElementById('connection-status');
                    indicator.style.background = 'rgba(0, 255, 65, 0.3)';
                    setTimeout(() => {
                        indicator.style.background = '';
                    }, 100);

                    // Update market session if provided
                    if (data.marketSession) {
                        document.getElementById('sessionName').textContent = data.marketSession;
                    }
                }
            };

            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
                const statusEl = document.getElementById('connection-status');
                statusEl.innerHTML = 'üî¥ Error';
                statusEl.className = 'disconnected';
            };

            ws.onclose = () => {
                const statusEl = document.getElementById('connection-status');
                statusEl.innerHTML = 'üü° Reconnecting...';
                statusEl.className = 'connecting';
                setTimeout(connect, 3000);
            };
        }

        function formatVolumeChange(change) {
            if (!change || change === 0) return '<span class="volume-change volume-normal">0%</span>';

            const absChange = Math.abs(change);
            let className = 'volume-normal';

            if (absChange >= 50) {
                className = 'volume-spike';
            } else if (absChange >= 20) {
                className = 'volume-surge';
            }

            const sign = change > 0 ? '+' : '';
            return `<span class="volume-change ${className}">${sign}${change.toFixed(1)}%</span>`;
        }

        // Format volume rate/activity indicator - shows volume per minute or % change
        function formatVolumeIndicator(stock) {
            // Check for volume rate (volume per minute)
            if (stock.volumeRate && stock.volumeRate > 0) {
                const rate = stock.volumeRate;
                let rateDisplay = '';
                let className = 'volume-normal';

                // Format rate based on magnitude
                if (rate >= 1000000) {
                    rateDisplay = (rate / 1000000).toFixed(1) + 'M/min';
                    className = 'volume-spike';
                } else if (rate >= 100000) {
                    rateDisplay = (rate / 1000).toFixed(0) + 'K/min';
                    className = 'volume-surge';
                } else if (rate >= 10000) {
                    rateDisplay = (rate / 1000).toFixed(1) + 'K/min';
                    className = 'volume-surge';
                } else if (rate >= 1000) {
                    rateDisplay = (rate / 1000).toFixed(1) + 'K/min';
                } else {
                    rateDisplay = rate.toFixed(0) + '/min';
                }

                // Add acceleration indicator
                let accelSymbol = '';
                if (stock.volumeAcceleration === 'increasing') {
                    accelSymbol = ' ‚Üë‚Üë';
                    className = 'volume-spike';
                } else if (stock.volumeAcceleration === 'steady') {
                    accelSymbol = ' ‚Üí';
                }

                return `<span class="volume-change ${className}" title="Volume Rate: ${rate.toLocaleString()} shares/min">${rateDisplay}${accelSymbol}</span>`;
            }

            // Always show 30s volume change - this is the primary indicator
            const change = stock.volumeChanges?.['30s'];
            if (change !== undefined && change !== null) {
                // Show the actual percentage change, even if 0%
                return formatVolumeChange(change);
            }

            // Default to 0% if no data
            return '<span class="volume-change volume-normal">0%</span>';
        }

        function formatPriceChange(change) {
            if (!change || change === 0) return '<span class="price-change price-neutral">0.0%</span>';

            const absChange = Math.abs(change);
            let intensityClass = '';
            let directionClass = change > 0 ? 'price-positive' : 'price-negative';

            // Use different thresholds for price changes (smaller movements are more significant)
            if (absChange >= 2) {
                intensityClass = 'price-spike';
            } else if (absChange >= 0.5) {
                intensityClass = 'price-surge';
            } else {
                intensityClass = 'price-normal';
            }

            const sign = change > 0 ? '+' : '';
            return `<span class="price-change ${directionClass} ${intensityClass}">${sign}${change.toFixed(2)}%</span>`;
        }

        function formatBuyPressure(pressure) {
            // Parse as float to handle string values
            pressure = parseFloat(pressure);
            if (isNaN(pressure)) pressure = 50; // Default to neutral if invalid

            // Clamp between 0 and 100
            pressure = Math.max(0, Math.min(100, pressure));

            // Determine color based on pressure level
            let color = '#888'; // Neutral gray
            let emoji = '‚ûñ';

            if (pressure >= 70) {
                color = '#00ff41'; // Strong buy pressure - green
                emoji = 'üü¢';
            } else if (pressure >= 60) {
                color = '#88ff88'; // Moderate buy pressure - light green
                emoji = 'üü¢';
            } else if (pressure <= 30) {
                color = '#ff4444'; // Strong sell pressure - red
                emoji = 'üî¥';
            } else if (pressure <= 40) {
                color = '#ff8888'; // Moderate sell pressure - light red
                emoji = 'üî¥';
            }

            // Create a visual bar
            const barWidth = 60;
            const fillWidth = Math.round((pressure / 100) * barWidth);

            return `
                <div style="display: flex; align-items: center; gap: 5px;">
                    <span style="font-size: 0.8em;">${emoji}</span>
                    <div style="width: ${barWidth}px; height: 10px; background: #222; border: 1px solid #444; position: relative;">
                        <div style="width: ${fillWidth}px; height: 100%; background: ${color};"></div>
                    </div>
                    <span style="color: ${color}; font-size: 0.9em; min-width: 30px;">${pressure.toFixed(0)}</span>
                </div>
            `;
        }

        function updateTable(stocks) {
            allStocks = stocks;

            // Apply filters - use totalVolume for filtering, not session-specific volume
            let filteredStocks = stocks
                .filter(stock => {
                    // Use totalVolume if available, otherwise fall back to volume
                    const volumeToCheck = stock.totalVolume || stock.volume || 0;

                    // Apply price filter
                    let priceMatch = true;
                    const priceFilter = document.getElementById('priceFilter').value;
                    if (priceFilter !== 'all') {
                        const price = stock.price || 0;
                        if (priceFilter === 'penny') {
                            priceMatch = price < 5;
                        } else if (priceFilter === 'low') {
                            priceMatch = price >= 5 && price <= 20;
                        } else if (priceFilter === 'mid') {
                            priceMatch = price > 20 && price <= 100;
                        } else if (priceFilter === 'high') {
                            priceMatch = price > 100;
                        }
                    }

                    return volumeToCheck >= filters.minVolume &&
                           stock.dayChange >= filters.minGain &&
                           priceMatch;
                });

            // Apply complex multi-criteria sorting
            filteredStocks.sort((a, b) => {
                let compareValue = 0;

                // Check if price or volume sort overrides primary sort
                if (filters.priceSortBy !== 'none') {
                    // Price sort takes precedence
                    const timeframe = filters.priceSortBy.replace('priceChange', '');
                    const aPriceChange = a.priceChanges?.[timeframe] || 0;
                    const bPriceChange = b.priceChanges?.[timeframe] || 0;
                    compareValue = bPriceChange - aPriceChange;
                } else if (filters.volumeSortBy !== 'none') {
                    // Volume sort takes precedence
                    const timeframe = filters.volumeSortBy.replace('volumeChange', '');
                    const aVolChange = a.volumeChanges?.[timeframe] || 0;
                    const bVolChange = b.volumeChanges?.[timeframe] || 0;
                    compareValue = bVolChange - aVolChange;
                } else {
                    // Use primary sort
                    if (filters.primarySort === 'dayChange') {
                        compareValue = b.dayChange - a.dayChange;
                    } else if (filters.primarySort === 'price') {
                        compareValue = b.price - a.price;
                    } else if (filters.primarySort === 'volume') {
                        compareValue = b.volume - a.volume;
                    } else if (filters.primarySort === 'buyPressure') {
                        const aBuyPressure = parseFloat(a.buyPressure) || 50;
                        const bBuyPressure = parseFloat(b.buyPressure) || 50;
                        compareValue = bBuyPressure - aBuyPressure;
                    }

                    // Apply sort direction for primary sort
                    if (filters.primarySortDirection === 'asc') {
                        compareValue = -compareValue;
                    }
                }

                // If equal, fall back to day change
                if (compareValue === 0) {
                    compareValue = b.dayChange - a.dayChange;
                }

                return compareValue;
            });

            // Limit
            filteredStocks = filteredStocks.slice(0, filters.stockLimit);

            // Count surges
            const surgeCount = filteredStocks.filter(s =>
                Object.values(s.volumeChanges).some(v => Math.abs(v) >= 20)
            ).length;

            // Update stats
            document.getElementById('stockCount').textContent = filteredStocks.length;
            document.getElementById('surgeCount').textContent = surgeCount;
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();

            // Build table HTML
            const tbody = document.getElementById('tableBody');
            if (filteredStocks.length === 0) {
                tbody.innerHTML = '<tr class="loading"><td colspan="15">No stocks match current filters</td></tr>';
                return;
            }

            tbody.innerHTML = filteredStocks.map((stock, index) => {
                const volumeClass = stock.volume > 10000000 ? 'high-volume' : '';
                const priceClass = stock.dayChange >= 0 ? 'positive' : 'negative';

                // Format position change
                let positionDisplay = '';
                const posChange = stock.volumePositionChange || 0;
                if (posChange > 0) {
                    positionDisplay = `<span style="color: #00ff41; font-weight: bold;">‚Üë${posChange}</span>`;
                } else if (posChange < 0) {
                    positionDisplay = `<span style="color: #ff4444; font-weight: bold;">‚Üì${Math.abs(posChange)}</span>`;
                } else {
                    positionDisplay = `<span style="color: #888;">-</span>`;
                }

                return `
                <tr>
                    <td style="text-align: center;">
                        <div style="display: flex; align-items: center; gap: 5px; justify-content: center;">
                            <span style="color: #888;">${stock.volumeRank || (index + 1)}</span>
                            ${positionDisplay}
                        </div>
                    </td>
                    <td class="symbol">${stock.symbol}</td>
                    <td>$${stock.price.toFixed(2)}</td>
                    <td class="${priceClass}">
                        ${stock.dayChange >= 0 ? '+' : ''}${stock.dayChange.toFixed(2)}%
                    </td>
                    <td>${formatBuyPressure(stock.buyPressure || 50)}</td>
                    <td>${formatPriceChange(stock.priceChanges ? stock.priceChanges['30s'] : 0)}</td>
                    <td>${formatPriceChange(stock.priceChanges ? stock.priceChanges['1m'] : 0)}</td>
                    <td>${formatPriceChange(stock.priceChanges ? stock.priceChanges['2m'] : 0)}</td>
                    <td>${formatPriceChange(stock.priceChanges ? stock.priceChanges['3m'] : 0)}</td>
                    <td>${formatPriceChange(stock.priceChanges ? stock.priceChanges['5m'] : 0)}</td>
                    <td>${formatVolumeIndicator(stock)}</td>
                    <td>${formatVolumeChange(stock.volumeChanges['1m'])}</td>
                    <td>${formatVolumeChange(stock.volumeChanges['2m'])}</td>
                    <td>${formatVolumeChange(stock.volumeChanges['3m'])}</td>
                    <td>${formatVolumeChange(stock.volumeChanges['5m'])}</td>
                    <td class="${volumeClass}" title="${stock.volumeLabel || 'Volume'}">${(stock.volume / 1000000).toFixed(2)}M</td>
                </tr>
            `}).join('');
        }

        // Fetch initial data
        async function fetchInitialData() {
            try {
                const response = await fetch('/api/volume');
                const data = await response.json();
                if (data.success) {
                    updateTable(data.stocks);

                    // Update market session if provided
                    if (data.marketSession) {
                        document.getElementById('sessionName').textContent = data.marketSession;
                    }
                }
            } catch (error) {
                console.error('Error fetching data:', error);
            }
        }

        // Start
        connect();
        // Fetch initial data only once
        fetchInitialData();
    </script>
</body>
</html>